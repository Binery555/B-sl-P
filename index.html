<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Binance Futures Positions</title>
  <!-- Binance Plex Webfont -->
  <link href="https://db.onlinewebfonts.com/c/d05c19ccecf7003d248c60ffd6b5e8f7?family=Binance+PLEX" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --panel-bg: #1e2127;
      --secondary-bg: #32383e;
      --btn-bg: #2f3339;
      --text-primary: #ffffff;
      --text-secondary: #7c828a;
      --text-green: #3acf87;
      --text-red: #e04b4a;
      --highlight: #f0b90b;
    }
    body {
      background-color: var(--panel-bg);
      color: #b0b0b0;
      font-family: 'Binance PLEX', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 430px;
      margin: 0 auto;
    }

    .header-wrapper { display: flex; justify-content: center; margin-top: 12px; margin-bottom: 4px; background: var(--panel-bg); }
    .header-toggle { display: flex; background: var(--panel-bg); border-radius: 6px; overflow: hidden; width: 180px; height: 28px; }
    .header-toggle button { flex: 1; padding: 4px 6px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; cursor: pointer; }
    .header-toggle .active { background: var(--secondary-bg); color: var(--text-primary); font-weight: 500; }

    /* shift nav & toggles 0.1cm right */
    nav.main-nav, .sub-toggle, .section-toggle { transform: translateX(0.1cm); }

    nav.main-nav { display: flex; margin: 0 12px; background: var(--panel-bg); padding: 4px 0; }
    nav.main-nav a { margin-right: 16px; text-decoration: none; color: var(--text-secondary); font-size: 13px; padding: 8px 0; white-space: nowrap; }
    nav.main-nav a.active { color: var(--text-primary); font-weight: 500; }

    .sub-toggle { display: flex; margin: 8px 12px; background: var(--panel-bg); padding: 4px; border-radius: 4px; }
    .sub-toggle button { margin-right: 8px; padding: 5px 10px; background: var(--panel-bg); border: none; border-radius: 4px; color: var(--text-secondary); font-size: 12px; cursor: pointer; }
    .sub-toggle .active { background: var(--secondary-bg); color: var(--text-primary); }

    .section-toggle { display: flex; margin: 12px; background: var(--panel-bg); padding: 4px; border-radius: 4px; }
    .section-toggle div { margin-right: 16px; cursor: pointer; font-size: 13px; position: relative; color: var(--text-secondary); }
    .section-toggle .active { color: var(--text-primary); font-weight: 500; }
    .section-toggle .active::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 20px; height: 2px; background: var(--highlight); }

    .feed { display: flex; flex-direction: column; gap: 8px; flex: 1; overflow-y: auto; padding: 0 12px; margin-bottom: 4px; background: var(--panel-bg); }
    .feed::-webkit-scrollbar { display: none; }

    .trade-panel { background: var(--panel-bg); padding: 12px; border-radius: 8px; transition: transform 0.5s ease; }
    .trade-panel .header { display: flex; align-items: center; margin-bottom: 8px; }
    .icon-buy { background: var(--text-green); color: #fff; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 8px; }
    .symbol { font-size: 14px; font-weight: 500; margin-right: 6px; color: var(--text-primary); }
    .tag { background: var(--secondary-bg); color: var(--text-secondary); font-size: 10px; padding: 1px 4px; margin-right: 4px; text-transform: uppercase; border-radius: 3px; }
    .exclamations { display: flex; margin-left: 6px; }
    .exclamations span { position: relative; width: 2px; height: 10px; background: var(--secondary-bg); margin: 0 1px; border-radius: 1px; transition: background 0.3s ease; }
    .exclamations span::after { content: ''; position: absolute; bottom: -3px; left: 50%; transform: translateX(-50%); width: 2px; height: 2px; background: inherit; border-radius: 50%; }
    .exclamations span.green, .exclamations span.green::after { background: var(--text-green); }
    .share { margin-left: auto; color: var(--text-secondary); font-size: 16px; cursor: pointer; }

    .content-columns { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
    .column { display: flex; flex-direction: column; }
    .column.right { text-align: right; }
    .stat { margin-bottom: 8px; }
    .label { font-size: 12px; color: var(--text-secondary); border-bottom: 1px dotted var(--text-secondary); padding-bottom: 2px; display: inline-block; }
    .label.no-line { border-bottom: none; }
    .value { font-size: 14px; font-weight: 400; color: var(--text-primary); transition: all 0.3s ease; }
    .value.green, .value.percent.green { color: var(--text-green); font-size: 18px; font-weight: bold; }
    .value.red, .value.percent.red { color: var(--text-red); font-size: 18px; font-weight: bold; }
    .margin-ratio-value { font-size: 12px !important; }

    .actions { display: flex; justify-content: space-between; }
    .btn { flex: 1; background: var(--btn-bg); color: #fff; border: none; border-radius: 4px; padding: 6px 0; font-size: 12px; cursor: pointer; margin: 0 4px; transition: background 0.3s; }
    .btn:hover { background: var(--secondary-bg); }
  </style>
</head>
<body>
  <!-- Centered Toggle -->
  <div class="header-wrapper">
    <div class="header-toggle">
      <button class="active">Exchange</button>
      <button>Wallet</button>
    </div>
  </div>

  <!-- Main Navigation -->
  <nav class="main-nav">
    <a href="#" class="active">Overview</a>
    <a href="#">Funding</a>
    <a href="#futures">Futures</a>
    <a href="#">Spot</a>
  </nav>

  <!-- Sub Toggle -->
  <div class="sub-toggle">
    <button class="active">USDⓈ-M</button>
    <button>COIN-M</button>
  </div>

  <!-- Section Toggle -->
  <div class="section-toggle">
    <div class="active">Positions</div>
    <div>Assets</div>
  </div>

  <!-- Profit Feed Container -->
  <div class="feed"></div>

  <script>
    /** -----------------------------
     * Precision per symbol
     * ------------------------------*/
    const symbolPrecisions = {
      BTCUSDT: 2, ETHUSDT: 2, BNBUSDT: 2, ADAUSDT: 3, SOLUSDT: 3, XRPUSDT: 4, DOTUSDT: 3, LTCUSDT: 2,
      LINKUSDT: 3, DOGEUSDT: 4, AAVEUSDT: 3, SUSHIUSDT: 3, SHIBUSDT: 6, COMPUSDT: 3, ETCUSDT: 3, ZECUSDT: 2,
      XMRUSDT: 2, LRCUSDT: 4, QNTUSDT: 3, CRVUSDT: 4, UNIUSDT: 3, BCHUSDT: 2, XLMUSDT: 4, ATOMUSDT: 3,
      MATICUSDT: 4, AVAXUSDT: 3, TRXUSDT: 4, EOSUSDT: 3, NEARUSDT: 3, FILUSDT: 3
    };
    function getPrecision(sym) { return symbolPrecisions[sym] ?? 2; }
    function formatBySymbol(sym, x) {
      const p = getPrecision(sym);
      const s = x.toFixed(p);
      const [i, d] = s.split('.');
      const iFmt = i.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return d !== undefined ? `${iFmt}.${d}` : iFmt;
    }
    function formatTwoDP(x) {
      const s = x.toFixed(2);
      const [i, d] = s.split('.');
      return i.replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "." + d;
    }

    /** -----------------------------
     * Maintenance Margin Rate (simplified symbol map)
     * ------------------------------*/
    const maintenanceMarginRates = {
      BTCUSDT: 0.004, ETHUSDT: 0.005, BNBUSDT: 0.005, ADAUSDT: 0.010, SOLUSDT: 0.008, XRPUSDT: 0.010,
      DOTUSDT: 0.010, LTCUSDT: 0.010, LINKUSDT: 0.010, DOGEUSDT: 0.012, AAVEUSDT: 0.010, SUSHIUSDT: 0.015,
      SHIBUSDT: 0.020, COMPUSDT: 0.010, ETCUSDT: 0.010, ZECUSDT: 0.015, XMRUSDT: 0.020, LRCUSDT: 0.020,
      QNTUSDT: 0.015, CRVUSDT: 0.020, UNIUSDT: 0.010, BCHUSDT: 0.010, XLMUSDT: 0.015, ATOMUSDT: 0.010,
      MATICUSDT: 0.010, AVAXUSDT: 0.010, TRXUSDT: 0.020, EOSUSDT: 0.015, NEARUSDT: 0.020, FILUSDT: 0.015
    };
    function getMaintRate(sym) { return maintenanceMarginRates[sym] ?? 0.01; }

    /** -----------------------------
     * Settings
     * ------------------------------*/
    const symbols = Object.keys(symbolPrecisions);
    const allowedLeverages = [10, 20, 50, 100];
    const updateInterval = 2000;                  // ms
    const driftPerUpdate = 0.0002;                // slow upward drift
    const jitter = 0.0015;                        // ±0.15% jitter each tick
    const tradeCount = 20;                        // number of panels
    const marginMin = 50;                         // requested margin range
    const marginMax = 1000;

    // helpers
    const randRange = (a, b) => a + Math.random() * (b - a);

    /** -----------------------------
     * Core calcs (Linear USDT, Long)
     * ------------------------------*/
    // Qty opened at entry using *used* margin and leverage
    const qtyFrom = (marginUsed, leverage, entry) => (leverage * marginUsed) / entry;

    // Unrealized PnL (long) = (Mark - Entry) * Qty
    const upnl = (mark, entry, qty) => (mark - entry) * qty;

    // ROI% = PnL / usedMargin * 100
    const roiPct = (pnl, usedMargin) => (pnl / usedMargin) * 100;

    // Maintenance = MMR * Mark * Qty
    const maintenance = (mmr, mark, qty) => mmr * mark * qty;

    // Margin Balance (equity in the position bucket):
    // Cross: effectiveMargin (used + extra buffer) + uPnL
    const marginBalance = (effectiveMargin, uPnL) => effectiveMargin + uPnL;

    // Liquidation Price (long) solving: M_eff + (P - E)*Q = MMR*P*Q
    // => P = (Q*E - M_eff) / (Q*(1 - MMR))
    function liqPriceLong(entry, leverage, mmr, marginUsed, effectiveMargin) {
      const Q = qtyFrom(marginUsed, leverage, entry);
      const denom = Q * (1 - mmr);
      const num = Q * entry - effectiveMargin;
      if (denom <= 0) return null;
      const P = num / denom;
      if (!isFinite(P) || P <= 0) return null;
      return P;
    }

    /** -----------------------------
     * Build UI
     * ------------------------------*/
    const feedDiv = document.querySelector('.feed');

    // small visual meter bars
    function meterBars() {
      let html = '';
      const totalBars = 4;
      const greenBars = Math.floor(Math.random() * totalBars) + 1;
      for (let j = 0; j < totalBars; j++) {
        html += `<span class="${j < greenBars ? 'green' : ''}"></span>`;
      }
      return html;
    }

    // Create one trade panel
    function createPanel({ sym, leverage, entry, mark, usedMargin, effMargin, mmr }) {
      const mode = 'Cross'; // <— forced Cross only
      const notionalUSDT = usedMargin * leverage;
      const qty = qtyFrom(usedMargin, leverage, entry);
      const pnl = upnl(mark, entry, qty);
      const roi = roiPct(pnl, usedMargin);
      const maint = maintenance(mmr, mark, qty);
      const mBal = marginBalance(effMargin, pnl);
      const mRatio = marginRatioPct(maint, mBal);
      const liq = liqPriceLong(entry, leverage, mmr, usedMargin, effMargin);

      const panel = document.createElement('div');
      panel.className = 'trade-panel';
      panel.innerHTML = `
        <div class="header">
          <span class="icon-buy">B</span>
          <span class="symbol">${sym}</span>
          <span class="tag">PERP</span>
          <span class="tag">${mode} ${leverage}×</span>
          <span class="exclamations">${meterBars()}</span>
          <i class="fas fa-share-alt share"></i>
        </div>

        <div class="content-columns">
          <div class="column">
            <div class="stat">
              <div class="label">PNL (USDT)</div>
              <div class="value pnl ${pnl < 0 ? 'red' : 'green'}">${formatTwoDP(pnl)}</div>
            </div>
            <div class="stat">
              <div class="label">Size (USDT)</div>
              <div class="value size">${formatTwoDP(notionalUSDT)}</div>
            </div>
            <div class="stat">
              <div class="label">Entry Price (USDT)</div>
              <div class="value entry">${formatBySymbol(sym, entry)}</div>
            </div>
          </div>

          <div class="column center">
            <div class="stat">
              <div class="label no-line">Margin (USDT)</div>
              <div class="value margin">${formatTwoDP(usedMargin)}</div>
            </div>
            <div class="stat">
              <div class="label no-line">Mark Price (USDT)</div>
              <div class="value mark">${formatBySymbol(sym, mark)}</div>
            </div>
          </div>

          <div class="column right">
            <div class="stat">
              <div class="label">ROI</div>
              <div class="value percent roi ${roi < 0 ? 'red' : 'green'}">${(roi >= 0 ? '+' : '') + roi.toFixed(2)}%</div>
            </div>
            <div class="stat margin-ratio">
              <div class="label">Margin Ratio</div>
              <div class="value percent margin-ratio-value ${mRatio >= 80 ? 'red' : 'green'}">${mRatio.toFixed(2)}%</div>
            </div>
            <div class="stat">
              <div class="label no-line">Liq. Price (USDT)</div>
              <div class="value liq">${liq === null ? '—' : formatBySymbol(sym, liq)}</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn">Leverage</button>
          <button class="btn">TP/SL</button>
          <button class="btn">Close</button>
          <button class="btn">Reverse</button>
        </div>
      `;

      return {
        node: panel,
        sym, leverage, mmr,
        entry,
        usedMargin,
        effMargin,
        qty,
        mark
      };
    }

    // Margin Ratio % = Maintenance / MarginBalance * 100
    const marginRatioPct = (maint, mBal) => (mBal <= 0 ? 100 : (maint / mBal) * 100);

    /** -----------------------------
     * Live init + update
     * ------------------------------*/
    async function init() {
      try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/price');
        const list = await res.json();
        const priceMap = Object.fromEntries(list.map(d => [d.symbol, parseFloat(d.price)]));

        const trades = [];

        for (let i = 0; i < tradeCount; i++) {
          const sym = symbols[i % symbols.length];
          const live = priceMap[sym];
          if (!live || !isFinite(live)) continue;

          // entry ≈ 6% lower than live; mark ≈ 2% lower than live
          const entry = live * 0.94;
          const mark0 = live * 0.98;

          const leverage = allowedLeverages[Math.floor(Math.random() * allowedLeverages.length)];

          // Margin used to open the position (USDT)
          const usedMargin = randRange(marginMin, marginMax);

          // Cross-only: simulate extra wallet balance to widen liq buffer
          const effMargin = usedMargin * randRange(1.5, 4.0);

          const mmr = getMaintRate(sym);

          const panelState = createPanel({
            sym, leverage, entry, mark: mark0, usedMargin, effMargin, mmr
          });

          trades.push(panelState);
          feedDiv.appendChild(panelState.node);
        }

        // periodic updates: gentle drift + small jitter; recalc all metrics from prices
        setInterval(() => {
          trades.forEach(t => {
            // update mark with drift ± jitter
            let drifted = t.mark * (1 + driftPerUpdate);
            const j = (Math.random() * 2 - 1) * jitter;
            drifted *= (1 + j);
            t.mark = drifted;

            // recompute metrics
            const pnl = upnl(t.mark, t.entry, t.qty);
            const roi = roiPct(pnl, t.usedMargin);
            const maint = maintenance(t.mmr, t.mark, t.qty);
            const mBal = marginBalance(t.effMargin, pnl);
            const mRatio = marginRatioPct(maint, mBal);
            const liq = liqPriceLong(t.entry, t.leverage, t.mmr, t.usedMargin, t.effMargin);

            // update DOM
            const pnlEl = t.node.querySelector('.value.pnl');
            pnlEl.textContent = formatTwoDP(pnl);
            pnlEl.classList.toggle('green', pnl >= 0);
            pnlEl.classList.toggle('red', pnl < 0);

            t.node.querySelector('.value.mark').textContent = formatBySymbol(t.sym, t.mark);

            const roiEl = t.node.querySelector('.value.roi');
            roiEl.textContent = (roi >= 0 ? '+' : '') + roi.toFixed(2) + '%';
            roiEl.classList.toggle('green', roi >= 0);
            roiEl.classList.toggle('red', roi < 0);

            const mrEl = t.node.querySelector('.value.margin-ratio-value');
            mrEl.textContent = mRatio.toFixed(2) + '%';
            mrEl.classList.toggle('green', mRatio < 80);
            mrEl.classList.toggle('red', mRatio >= 80);

            const liqEl = t.node.querySelector('.value.liq');
            liqEl.textContent = (liq === null) ? '—' : formatBySymbol(t.sym, liq);
          });
        }, updateInterval);

      } catch (e) {
        console.error('Failed to fetch Binance prices', e);
      }
    }

    init();
  </script>
</body>
</html>
